--Useful commands for working with the data generated by the tntgen program in a PostgreSQL database.
--This is NOT a script to be run from top to bottom! They are a copy/pasted scratchpad of useful Postgres commands to create a table, copy data from a flat file into that table, etc.
--Towards the end are bash commands that can be used to pull a CSV of query results back out from Postgres. They can be easily modified to work with other shells.
--I can make this file into something better (maybe an actual script or two) at a future date.

CREATE TABLE tnt(rules VARCHAR, kin VARCHAR, adds INT, tally INT, PRIMARY KEY(rules, kin, adds));

--assumes you wrote the data generated by the java program to ~/tnt.csv
\COPY tnt FROM '~/tnt.csv' CSV

CREATE OR REPLACE VIEW tnt_summary AS
WITH cte AS (
  SELECT rules, kin, adds, tally, round(sum(tally)/sum(sum(tally)) OVER (PARTITION BY rules, kin) * 100, 2) AS percentage
  FROM tnt
  GROUP BY rules, kin, adds, tally
  ORDER BY rules, kin, adds
)
SELECT *, sum(percentage) OVER (PARTITION BY rules, kin ORDER BY rules, kin, adds ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_perc
FROM cte
ORDER BY rules, kin, adds;

/* basic example queries */
SELECT *,
sum(percentage) OVER (PARTITION BY rules, kin ORDER BY rules, kin, adds ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_perc
FROM tnt_summary;

SELECT *,
sum(percentage) OVER (PARTITION BY rules, kin ORDER BY rules, kin, adds ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_perc
FROM tnt_summary
WHERE rules = 'FIFTH' AND kin = 'Human';

/* command line psql commands to generate a file per rulesset (this was useful for me to import into Google Sheets) this to csv with percentages and cumulative percentages; obviously replace path (or remove it if in your PATH, and this is for Mac btw; should be easily adjustable) */
---

/Applications/Postgres.app/Contents/Versions/12/bin/psql -p5432 mwrynn -c "SELECT kin, adds, tally, percentage, cumulative_perc FROM tnt_summary WHERE rules='FIFTH'" --tuples-only -A -F , >~/tnt_perc_fifth.csv

/Applications/Postgres.app/Contents/Versions/12/bin/psql -p5432 mwrynn -c "SELECT kin, adds, tally, percentage, cumulative_perc FROM tnt_summary WHERE rules='DELUXE'" --tuples-only -A -F , >~/tnt_perc_deluxe.csv

/Applications/Postgres.app/Contents/Versions/12/bin/psql -p5432 mwrynn -c "SELECT kin, adds, tally, percentage, cumulative_perc FROM tnt_summary WHERE rules='FIFTH_W_LOW_REROLL'" --tuples-only -A -F , >~/tnt_perc_fifth_reroll.csv

/Applications/Postgres.app/Contents/Versions/12/bin/psql -p5432 mwrynn -c "SELECT kin, adds, tally, percentage, cumulative_perc FROM tnt_summary WHERE rules='DELUXE_W_LOW_REROLL'" --tuples-only -A -F , >~/tnt_perc_deluxe_reroll.csv
